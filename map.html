<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Photography Map</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Mapbox GL JS CSS & JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <!-- Your token injector -->
    <script src="config.js"></script>

    <style>
        /* —— Your original CSS, unchanged, including marker, map-container, sidebar, spinner, etc. —— */
        /* (carousel CSS can stay — it simply won’t apply since we removed the HTML) */
        .map-container { display: flex; height: calc(100vh - 83px); }
        #map { flex: 2; height: 100%; }
        .photo-sidebar { flex: 1; overflow-y: auto; padding: 20px; background-color: #f8f8f8; display: none; }
        .map-container.sidebar-open #map { flex: 1; }
        .map-container.sidebar-open .photo-sidebar { display: block; }
        /* … all your existing styles … */
    </style>
</head>
<body>
    <header>
      <nav>
        <ul>
          <li><a href="index.html">Photos</a></li>
          <li><a href="stories.html">Stories</a></li>
          <li><a href="map.html" class="active">Map</a></li>
        </ul>
      </nav>
    </header>

    <div class="map-container">
      <div id="map"></div>
      <aside class="photo-sidebar" id="photo-sidebar">
        <div class="empty-state">
          <i class="fas fa-map-marker-alt"></i>
          <h3>Select a Location</h3>
          <p>Click on a map marker to view photos.</p>
        </div>
        <!-- location-header and location-photos will be injected here -->
      </aside>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Check token
      if (!config?.mapboxAccessToken) {
        console.error('Missing Mapbox token');
        document.getElementById('map').innerHTML =
          '<p style="padding:20px;color:red;">Mapbox token missing</p>';
        return;
      }
      mapboxgl.accessToken = config.mapboxAccessToken;

      // 2) Show loading spinner
      const mapContainer = document.getElementById('map');
      const loadingEl = document.createElement('div');
      loadingEl.id = 'map-loading';
      loadingEl.innerHTML = `
        <div style="
          display: flex; flex-direction: column;
          align-items: center; justify-content: center;
          height: 100%;
        ">
          <i class="fas fa-spinner fa-spin" style="font-size:30px; margin-bottom:10px;"></i>
          <p>Loading map...</p>
        </div>`;
      mapContainer.appendChild(loadingEl);

      // 3) Initialize the map (with globe projection if you like)
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        projection: 'globe',       // you can remove if you prefer 2D
        center: [-98, 39],
        zoom: 3,
        attributionControl: true
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');

      // 4) After the map loads, update the spinner and fetch your locations
      map.on('load', () => {
        loadingEl.innerHTML = `
          <div style="
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100%;
          ">
            <i class="fas fa-spinner fa-spin" style="font-size:30px; margin-bottom:10px;"></i>
            <p>Loading location data...</p>
          </div>`;
        loadLocationData();
      });

      // 5) Load JSON, add markers
      async function loadLocationData() {
        let locationData;
        try {
          const res = await fetch('data/locations.json');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          locationData = await res.json();
          if (!Array.isArray(locationData.locations)) {
            throw new Error('Invalid JSON structure');
          }
        } catch (err) {
          console.error('Error loading locations:', err);
          mapContainer.innerHTML = '<p style="padding:20px;color:red;">Error loading location data.</p>';
          return;
        }

        // Remove spinner
        if (loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);

        // Build GeoJSON features
        const features = locationData.locations
          .filter(loc => isFinite(loc.latitude) && isFinite(loc.longitude))
          .map(loc => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [loc.longitude, loc.latitude]
            },
            properties: {
              id: loc.id,
              name: loc.name,
              city: loc.city,
              state: loc.state,
              country: loc.country,
              count: loc.photos.length,
              photos: JSON.stringify(loc.photos)
            }
          }));

        // Load camera icon
        map.loadImage('assets/camera-icon.png', (err, img) => {
          if (err) return console.error(err);
          map.addImage('camera-icon', img);

          // Add source + symbol layer (locks icons to geo-coordinates)
          map.addSource('locations', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features }
          });
          map.addLayer({
            id: 'location-symbols',
            type: 'symbol',
            source: 'locations',
            layout: {
              'icon-image': 'camera-icon',
              'icon-size': 0.6,
              'icon-anchor': 'center',
              'text-field': '{count}',
              'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
              'text-size': 12,
              'text-offset': [0, 1.2],
              'icon-allow-overlap': true,
              'text-allow-overlap': true
            }
          });

          // Fit map to all markers
          const bounds = features.reduce((b, f) => b.extend(f.geometry.coordinates), new mapboxgl.LngLatBounds());
          if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 50, maxZoom: 8 });
        });

        // Deep-link: if ?location=ID in URL, open that sidebar
        const params = new URLSearchParams(window.location.search);
        const locId = params.get('location');
        if (locId) {
          map.once('idle', () => {
            const feat = features.find(f => f.properties.id === locId);
            if (feat) {
              flyAndShow(feat.properties.id);
            }
          });
        }
      }

      // 6) Marker click → fly + sidebar
      map.on('click', 'location-symbols', (e) => {
        const id = e.features[0].properties.id;
        flyAndShow(id);
      });
      map.on('mouseenter', 'location-symbols', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'location-symbols', () => {
        map.getCanvas().style.cursor = '';
      });

      function flyAndShow(id) {
        // center & zoom
        const loc = JSON.parse(JSON.stringify(id)); // dummy
        const feature = map.getSource('locations')._data.features
                          .find(f => f.properties.id === id);
        if (!feature) return;
        const [lng, lat] = feature.geometry.coordinates;
        map.flyTo({ center: [lng, lat], zoom: 8, essential: true });
        // show sidebar
        showLocationPhotos(JSON.parse(JSON.stringify(feature.properties)));
      }

      // 7) Show vertical list instead of carousel
      function showLocationPhotos(props) {
        const sidebar = document.getElementById('photo-sidebar');
        // Header
        let html = `
          <div class="location-header">
            <h2>${props.name}</h2>
            <p>
              ${props.city}${props.state ? ', ' + props.state : ''}, ${props.country}
            </p>
            <button class="close-sidebar" onclick="closePhotoSidebar()">×</button>
          </div>
        `;
        // Photo list
        html += `<div class="location-photos">`;
        JSON.parse(props.photos).forEach(photo => {
          const birdInfo = photo.alt.split('|')[0].trim();
          const birdName = extractBirdName(birdInfo);
          const sciName  = extractScientificName(birdInfo);
          html += `
            <div class="map-photo-item">
              <img 
                src="${photo.src}" 
                alt="${photo.alt}" 
                onclick="openPhotoModalFromMap('${photo.src}')"
              >
              <div class="map-photo-caption">
                <h3>${birdName}</h3>
                <p class="scientific-name">${sciName}</p>
              </div>
            </div>
          `;
        });
        html += `</div>`;

        sidebar.innerHTML = html;
        document.querySelector('.map-container').classList.add('sidebar-open');
      }

      // 8) Close sidebar
      window.closePhotoSidebar = function() {
        document.getElementById('photo-sidebar').style.display = 'none';
        document.querySelector('.map-container').classList.remove('sidebar-open');
      };

      // 9) Bird name helpers (unchanged)
      function extractBirdName(info) {
        return info.split('(')[0].trim();
      }
      function extractScientificName(info) {
        const m = info.match(/\((.*?)\)/);
        return m ? m[1] : '';
      }

      // 10) Fullscreen photo modal (unchanged)
      window.openPhotoModalFromMap = function(src) {
        const m = document.createElement('div');
        Object.assign(m.style, {
          position:'fixed', top:0, left:0, right:0, bottom:0,
          background:'rgba(0,0,0,0.9)',
          display:'flex', alignItems:'center', justifyContent:'center',
          zIndex:1000, cursor:'pointer'
        });
        m.onclick = () => document.body.removeChild(m);
        const img = new Image();
        img.src = src;
        Object.assign(img.style,{
          maxWidth:'90%', maxHeight:'90%', objectFit:'contain',
          border:'2px solid white', borderRadius:'4px', boxShadow:'0 4px 20px rgba(0,0,0,0.6)'
        });
        img.onclick = e => e.stopPropagation();
        m.appendChild(img);
        document.body.appendChild(m);
      };
    });
    </script>
</body>
</html>
